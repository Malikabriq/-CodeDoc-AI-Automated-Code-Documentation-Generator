# üìÑ `aiohttp.formdata` ‚Äì Form Body Generation Helper  

## 1. Module Purpose  

| Aspect | Description |
|--------|-------------|
| **Responsibility** | Provides a high‚Äëlevel API (`FormData`) for building HTTP request bodies that represent HTML forms. It can emit either **`multipart/form-data`** (for file uploads and complex values) or **`application/x-www-form-urlencoded`** (simple key/value pairs). |
| **Why it exists** | In `aiohttp`, request bodies must be supplied as a **`Payload`** object. Manually constructing multipart boundaries, content‚Äëdisposition headers, and URL‚Äëencoding is error‚Äëprone. `FormData` abstracts this boilerplate, handling: <br> ‚Ä¢ Detection of when multipart is required (e.g., when a file‚Äëlike object is added) <br> ‚Ä¢ Proper header generation (content‚Äëtype, content‚Äëdisposition) <br> ‚Ä¢ Charset handling and optional quoting of field names <br> ‚Ä¢ Compatibility shims for deprecated behaviours (bytes ‚Üí file field). |
| **Typical consumer** | End‚Äëusers of the `aiohttp` client (`await session.post(url, data=FormData(...))`) and internal `aiohttp` request‚Äëbuilding code that needs a ready‚Äëto‚Äësend `Payload`. |

---

## 2. Key Components  

### 2.1. `FormData` class  

| Element | Description |
|---------|-------------|
| **Purpose** | Container that accumulates form fields, decides on the encoding format, and finally produces a `Payload` (either a `BytesPayload` for url‚Äëencoded data or a `MultipartWriter` for multipart data). |
| **Constructor** `__init__(self, fields: Iterable[Any] = (), quote_fields: bool = True, charset: Optional[str] = None, *, default_to_multipart: bool = False) -> None` | - **`fields`** ‚Äì An initial iterable of fields. Accepts a mapping (`dict`), a list/tuple of `(name, value)` pairs, a single `io.IOBase` instance, or any mix of the above. <br> - **`quote_fields`** ‚Äì When `True`, multipart field names are quoted according to RFC 7578. <br> - **`charset`** ‚Äì Overrides the default UTF‚Äë8 charset used for URL‚Äëencoding and multipart `charset` parameters. <br> - **`default_to_multipart`** ‚Äì Forces multipart generation even if no file‚Äëlike objects are added. <br> **Side‚Äëeffects**: creates a private `MultipartWriter` (`self._writer`), stores the field list (`self._fields`), and populates the instance via `add_fields`. |
| **Public Property** `is_multipart` ‚Üí `bool` | Returns whether the current set of fields will be emitted as multipart. This flag is automatically toggled when a field that *requires* multipart is added (e.g., a file object, an explicit `filename`, a custom `content_type`). |
| **`add_field`** `def add_field(self, name: str, value: Any, *, content_type: Optional[str] = None, filename: Optional[str] = None, content_transfer_encoding: Optional[str] = None) -> None` | Adds a single field. <br> **Parameters**: <br> ‚Ä¢ `name` ‚Äì Form field name (string). <br> ‚Ä¢ `value` ‚Äì The payload; can be a primitive (`str`, `int`, ‚Ä¶), a bytes‚Äëlike object, or a file‚Äëlike object (`io.IOBase`). <br> ‚Ä¢ `content_type` ‚Äì Optional MIME type; forces multipart. <br> ‚Ä¢ `filename` ‚Äì Optional filename for file uploads; if omitted and `value` is a file object, the filename is guessed via `helpers.guess_filename`. <br> ‚Ä¢ `content_transfer_encoding` ‚Äì Deprecated; triggers a `DeprecationWarning`. <br> **Internal logic**: <br> 1. Detects file‚Äëlike objects ‚Üí forces multipart. <br> 2. Handles legacy bytes handling with a warning. <br> 3. Builds a `MultiDict` (`type_options`) containing at least `{"name": name}` and optionally `filename`. <br> 4. Validates supplied string arguments. <br> 5. Prepares a plain `dict` of additional headers (currently only possible `Content-Type`). <br> 6. Appends a tuple `(type_options, headers, value)` to `self._fields`. |
| **`add_fields`** `def add_fields(self, *fields: Any) -> None` | Bulk‚Äëadds several field specifications. Accepts the same flexible forms as the constructor: <br> ‚Ä¢ A single `io.IOBase` ‚Üí guessed name `"unknown"`.<br> ‚Ä¢ A `MultiDict` / `MultiDictProxy` ‚Üí extracts its items. <br> ‚Ä¢ A 2‚Äëtuple `(name, value)` ‚Üí passed to `add_field`. <br> **Raises** `TypeError` for unsupported structures. |
| **`_gen_form_urlencoded`** `def _gen_form_urlencoded(self) -> payload.BytesPayload` | Internal helper that builds an **`application/x-www-form-urlencoded`** payload: <br> 1. Extracts `(name, value)` pairs from `self._fields`. <br> 2. Determines charset (`self._charset` or `"utf-8"`). <br> 3. Calls `urllib.parse.urlencode(..., doseq=True, encoding=charset)`. <br> 4. Wraps the resulting `bytes` in a `payload.BytesPayload` with an appropriate `Content-Type`. |
| **`_gen_form_data`** `def _gen_form_data(self) -> multipart.MultipartWriter` | Internal helper that builds a **multipart/form-data** body: <br> 1. Iterates over stored fields. <br> 2. Calls `payload.get_payload(value, ‚Ä¶)` to obtain a `Payload` instance for each field, respecting any explicit `Content-Type` header. <br> 3. Sets the `Content‚ÄëDisposition` header on the part using `set_content_disposition("form-data", ...)` with the collected `type_options`. <br> 4. Strips any `Content‚ÄëLength` header (required for chunked transfer compatibility). <br> 5. Appends each part to the internal `MultipartWriter`. <br> 6. Clears `self._fields` and returns the writer. |
| **`__call__`** `def __call__(self) -> Payload` | Makes a `FormData` instance callable so that `form_data()` yields the final `Payload`. <br> - Returns a multipart writer if `self._is_multipart` is `True`. <br> - Otherwise returns the url‚Äëencoded `BytesPayload`. |
| **Public API** | - `FormData()` (constructor) <br> - `add_field(...)` and `add_fields(...)` <br> - `is_multipart` property <br> - Calling the instance (`payload = form_data()`) to obtain a `Payload`. |

---

## 3. Dependencies & Relationships  

### 3.1. Imported Modules  

| Import | Reason for Use |
|--------|----------------|
| `io` | Detects file‚Äëlike objects (`io.IOBase`). |
| `warnings` | Emits deprecation warnings for legacy behaviours (`bytes` ‚Üí file field, `content_transfer_encoding`). |
| `typing` (`Any`, `Iterable`, `List`, `Optional`) | Type hints for public signatures. |
| `urllib.parse.urlencode` | Implements URL‚Äëencoding for `application/x-www-form-urlencoded`. |
| `multidict.MultiDict`, `MultiDictProxy` | Provides a case‚Äëinsensitive, multi‚Äëvalue mapping for disposition parameters (e.g., `name`, `filename`). |
| **Local imports** | |
| `aiohttp.hdrs` | Symbolic HTTP header constants (`CONTENT_TYPE`, `CONTENT_LENGTH`). |
| `aiohttp.multipart` | `MultipartWriter` ‚Äì the core object that streams multipart bodies. |
| `aiohttp.payload` | Helpers to wrap various Python objects (`BytesPayload`, `get_payload`). |
| `aiohttp.helpers.guess_filename` | Heuristic to infer a sensible filename from a file‚Äëlike object. |
| `aiohttp.payload.Payload` | Abstract base class for payload objects; the return type of `FormData.__call__`. |

### 3.2. Interaction with the Rest of `aiohttp`  

| Direction | Component | Interaction Details |
|-----------|-----------|---------------------|
| **Depends on** | `aiohttp.multipart.MultipartWriter` | Used to compose the multipart stream, set boundaries, and manage part order. |
|  | `aiohttp.payload` (especially `BytesPayload` and `get_payload`) | Determines how each field value is turned into a concrete payload (bytes, streams, etc.). |
|  | `aiohttp.hdrs` | Provides canonical header names. |
|  | `aiohttp.helpers.guess_filename` | Supplies default filename when a file object is added without an explicit name. |
|  | `multidict` | Stores disposition parameters in a mutable mapping that can be iterated and copied safely. |
| **Potential Consumers** | `aiohttp.client._request` (internal request builder) | Calls `FormData()` when the user passes a `FormData` instance as the request `data=` argument. |
|  | User code (`aiohttp.ClientSession.post(..., data=FormData(...))`) | Public API is meant to be instantiated directly by developers. |
|  | Tests & utilities within the `aiohttp` codebase | May construct `FormData` to simulate browser form submissions. |

### 3.3. Architectural Placement  

- **Layer**: *Client‚Äëside request preparation* (just before the HTTP request is serialized onto the wire).  
- **Role**: Translates Python data structures into a `Payload` that conforms to HTTP‚Äôs form submission media types.  
- **Relation**: Sits between high‚Äëlevel user APIs (`ClientSession`) and low‚Äëlevel transport (`aiohttp.StreamWriter`).  

---

## 4. Workflow Description  

1. **Instantiation** (`FormData(fields, ...)`)  
   - Creates an empty `MultipartWriter` (`self._writer`).  
   - Normalises the incoming `fields` argument (dict ‚Üí list of items, non‚Äëlist/tuple ‚Üí singleton tuple).  
   - Calls `add_fields(*fields)` to populate internal `_fields`.  

2. **Adding Fields** (`add_field` / `add_fields`)  
   - **File‚Äëlike detection**: If the value is an `io.IOBase`, `self._is_multipart` becomes `True`.  
   - **Legacy bytes handling**: If a raw `bytes` value is passed **without** a filename, a `DeprecationWarning` is emitted and the field name is used as a pseudo‚Äëfilename.  
   - **Disposition assembly**: A `MultiDict` (`type_options`) always holds `{"name": name}` and optionally `filename`.  
   - **Headers assembly**: Optional `Content-Type` is stored in a plain dict. `content_transfer_encoding` is deprecated but accepted with a warning.  
   - The tuple `(type_options, headers, value)` is appended to `self._fields`.  

3. **Payload Generation** (`payload = form_data()`)  
   - `FormData.__call__` checks `self._is_multipart`.  
   - **If multipart** ‚Üí `self._gen_form_data()`  
     - For each stored field:  
       * Calls `payload.get_payload(value, ‚Ä¶)` which returns the appropriate `Payload` subclass (e.g., `BytesPayload`, `StringPayload`, `StreamReaderPayload`).  
       * If disposition parameters exist, calls `part.set_content_disposition("form-data", ...)` with possible quoting.  
       * Removes any `Content-Length` header to avoid conflicts with chunked transfer encoding.  
       * Appends the part to the internal `MultipartWriter`.  
     - Clears the `_fields` list (the writer now owns the data).  
     - Returns the `MultipartWriter` (a `Payload`).  
   - **If url‚Äëencoded** ‚Üí `_gen_form_urlencoded()`  
     - Builds a list of `(name, value)` pairs.  
     - Determines charset and appropriate `Content-Type` string.  
     - Calls `urllib.parse.urlencode` ‚Üí bytes.  
     - Wraps in a `payload.BytesPayload`.  

4. **Result**  
   - The returned `Payload` can be passed directly to `aiohttp` request methods (`session.post(..., data=payload)`).  
   - The writer handles boundary generation, streaming, and proper header emission when the request is finally sent.  

---

## 5. Usage Examples  

```python
from aiohttp import FormData, ClientSession

# 1Ô∏è‚É£ Simple URL‚Äëencoded form
data = FormData()
data.add_field('username', 'alice')
data.add_field('age', 30)

# a) Call the form to obtain the payload
payload = data()                       # Returns a BytesPayload

# b) Use directly with aiohttp client
async with ClientSession() as sess:
    async with sess.post('https://example.com/login', data=payload) as resp:
        print(await resp.text())
```

```python
# 2Ô∏è‚É£ Multipart form with a file upload
import pathlib

file_path = pathlib.Path('photo.jpg')
with file_path.open('rb') as f:
    form = FormData()
    form.add_field('description', 'My vacation photo')
    # Explicit filename, otherwise `guess_filename` would use 'photo.jpg'
    form.add_field('photo', f, filename='vacation.jpg', content_type='image/jpeg')

async with ClientSession() as sess:
    async with sess.post('https://example.com/upload', data=form) as resp:
        json_resp = await resp.json()
        print(json_resp)
```

```python
# 3Ô∏è‚É£ Pre‚Äëpopulating the form via the constructor (dict shortcut)
form = FormData({
    'search': 'aiohttp docs',
    'page': 2,
})                     # Will be URL‚Äëencoded because no file objects are present

async with ClientSession() as sess:
    async with sess.get('https://search.example.com/', params=form) as r:
        print(await r.text())
```

*Note*: In the last example `FormData` is used to build query parameters; the callable is **not** needed because `aiohttp` will internally call `form()` when assembling the request.

---

## 6. Notes for Developers  

| Area | Guidance / Gotchas |
|------|--------------------|
| **Automatic multipart detection** | Adding any `io.IOBase` (e.g., `open('file')`) automatically flips `is_multipart` to `True`. If you *explicitly* want multipart even without files, pass `default_to_multipart=True` at construction. |
| **Deprecation warnings** | - Passing raw `bytes` without a filename will raise a `DeprecationWarning`. Future versions will treat such values as plain form fields, not file uploads. <br> - `content_transfer_encoding` is deprecated; use an explicit `payload.BytesPayload(..., content_type=‚Ä¶)` if you need non‚Äëstandard encoding. |
| **Charset handling** | - URL‚Äëencoded payloads default to UTF‚Äë8. Supplying a different `charset` changes both the `Content-Type` header and the encoding used by `urllib.parse.urlencode`. <br> - Multipart parts inherit the writer‚Äôs charset via the `encoding` argument when `payload.get_payload` is called. |
| **Field name quoting** | `quote_fields` controls whether multipart field names are quoted per RFC 7578 (default `True`). Disable only when interacting with a server that misbehaves with quoted field names. |
| **Header management** | `add_field` only allows a custom `Content-Type`. All other headers must be supplied through the payload object itself (e.g., via a custom `Payload`). This keeps the API surface small and aligns with HTTP spec. |
| **Clearing of `self._fields`** | After `_gen_form_data` runs, the internal field list is cleared because the `MultipartWriter` now owns the data. Re‚Äëusing the same `FormData` instance without adding new fields will produce an empty payload. |
| **Thread‚Äësafety** | `FormData` is **not** thread‚Äësafe; it is intended for single‚Äërequest construction. If you need to share a template, clone it (`FormData(...).add_fields(...)`) before per‚Äëthread use. |
| **Extensibility** | To support a new Python type (e.g., a custom binary container), add handling logic in `aiohttp.payload.get_payload` or provide a custom `Payload` subclass and pass it as the `value` argument. `FormData` will treat it like any other value. |
| **Testing tip** | Use `multipart.MultipartWriter.boundary` (exposed via `_writer.boundary`) to assert that multipart bodies contain the expected boundary string in unit tests. |
| **Future compatibility** | The library will remove the automatic bytes‚Äëto‚Äëfile conversion in v5. When upgrading, explicitly provide a `filename` or wrap the bytes in a `BytesIO` object. |

--- 

*End of documentation.*