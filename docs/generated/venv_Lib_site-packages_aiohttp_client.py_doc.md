# aiohttp.client – HTTP Client Core Module  

*File: `venv\Lib\site-packages\aiohttp\client.py`*  

---

## 1. Module Purpose  

| Aspect | Description |
|--------|-------------|
| **Responsibility** | Implements the high‑level, asynchronous HTTP client API used throughout aiohttp. It provides: <br>• `ClientSession` – the primary entry point for issuing HTTP requests. <br>• `ClientTimeout` – a configurable timeout container. <br>• Support for WebSocket client connections (`ws_connect`). <br>• Context‑manager wrappers that make a request usable with `async with`. |
| **Why it exists** | aiohttp separates the client‑side logic from the server‑side (`aiohttp.web`). This module encapsulates all request construction, connector handling, cookie management, automatic redirects, tracing, middlewares, and error translation. It shields the user from low‑level networking details while still exposing fine‑grained configuration (SSL, proxies, timeouts, etc.). |

---

## 2. Key Components  

### 2.1 Constants & Helper Types  

| Name | Type / Meaning |
|------|----------------|
| `DEFAULT_TIMEOUT` | `ClientTimeout` – default 5 min total, 30 s socket‑connect timeout. |
| `IDEMPOTENT_METHODS` | `frozenset` of HTTP methods that are safe to retry on persistent‑connection failures. |
| `_RequestOptions` | `TypedDict` (type‑checked optional arguments for `ClientSession.request`). |
| `_RetType` | `TypeVar` bound to `ClientResponse` or `ClientWebSocketResponse`. |
| `_CharsetResolver` | Callable used to resolve a response charset. |

### 2.2 `ClientTimeout`  

* **Purpose** – Simple immutable container for the various timeout values a request may need.  
* **Attributes** (all optional `float`):  
  * `total` – overall request timeout.  
  * `connect` – DNS/connection establishment timeout.  
  * `sock_read` – socket read timeout.  
  * `sock_connect` – timeout for establishing a TCP connection.  
  * `ceil_threshold` – threshold used by the internal `TimeoutHandle` to decide when to round‑up the timeout value.  
* **Usage** – Passed to `ClientSession` or per‑request via the `timeout=` argument. Instances are created via `ClientTimeout(...)` or altered with `attr.evolve`.  

### 2.3 `ClientSession`  

| Aspect | Detail |
|--------|--------|
| **What it does** | Provides a stateful, reusable client for HTTP/HTTPS (and WS) communication. Manages a connector pool, default headers, cookie jar, authentication, proxy handling, tracing, and middleware pipelines. |
| **Constructor** | `ClientSession(base_url=None, *, connector=None, loop=None, cookies=None, headers=None, proxy=None, proxy_auth=None, skip_auto_headers=None, auth=None, json_serialize=json.dumps, request_class=ClientRequest, response_class=ClientResponse, ws_response_class=ClientWebSocketResponse, version=http.HttpVersion11, cookie_jar=None, connector_owner=True, raise_for_status=False, read_timeout=sentinel, conn_timeout=None, timeout=sentinel, auto_decompress=True, trust_env=False, requote_redirect_url=True, trace_configs=None, read_bufsize=2**16, max_line_size=8190, max_field_size=8190, fallback_charset_resolver=lambda r, b: "utf-8", middlewares=(), ssl_shutdown_timeout=sentinel)` |
| **Important attributes (public properties)** | `closed`, `connector`, `cookie_jar`, `version`, `timeout`, `headers`, `skip_auto_headers`, `auth`, `json_serialize`, `connector_owner`, `raise_for_status`, `auto_decompress`, `trust_env`, `trace_configs` |
| **Core public methods** | <ul><li>`request(method, url, **kwargs)` – low‑level entry point returning a `_RequestContextManager` (awaitable context manager).</li><li>Convenience helpers: `get`, `post`, `put`, `patch`, `delete`, `head`, `options` – thin wrappers around `request` with appropriate defaults.</li><li>`ws_connect(url, **kwargs)` – initiates a WebSocket handshake and returns a `_WSRequestContextManager`.</li><li>`close()` – gracefully shuts down the connector (if owned).</li></ul> |
| **Internal helpers** | `_build_url`, `_prepare_headers`, `_get_netrc_auth`, `_ws_connect`. |
| **Context manager protocol** | Implements `__aenter__`/`__aexit__` for `async with ClientSession(...) as sess:`. The synchronous `__enter__` raises `TypeError` to enforce async usage. |
| **Lifecycle notes** | The session records a traceback at creation (if loop debug enabled) and warns on garbage collection if still open. The `detach()` method can detach the connector without closing it (session becomes “closed”). |
| **Middleware support** | Accepts a sequence of `ClientMiddlewareType`. They are composed into a single handler via `build_client_middlewares`. Middleware may modify the request or response, or implement retry logic. |

### 2.4 Request Context Managers  

| Class | Purpose | Generic Return |
|-------|---------|----------------|
| `_BaseRequestContextManager[_RetType]` | Wraps the coroutine returned by `ClientSession._request` (or `_ws_connect`) and makes it an awaitable context manager. Handles `__aenter__`/`__aexit__` to open/close the underlying `ClientResponse`/`ClientWebSocketResponse`. | `ClientResponse` or `ClientWebSocketResponse` |
| `_RequestContextManager` | Alias of `_BaseRequestContextManager[ClientResponse]` – the type returned by `ClientSession.request` and its convenience methods. |
| `_WSRequestContextManager` | Alias of `_BaseRequestContextManager[ClientWebSocketResponse]` – returned by `ClientSession.ws_connect`. |
| `_SessionRequestContextManager` | Helper used by the module‑level `request` function. It creates a temporary `ClientSession`, performs a request, and ensures both the response **and** the session are closed on exit. |

### 2.5 Module‑level `request` function  

* **Signature** (runtime)  

```python
def request(
    method: str,
    url: StrOrURL,
    *,
    version: HttpVersion = http.HttpVersion11,
    connector: Optional[BaseConnector] = None,
    loop: Optional[asyncio.AbstractEventLoop] = None,
    **kwargs: Any,
) -> _SessionRequestContextManager:
    ...
```

* **What it does** – Provides a **single‑shot** convenience for fire‑and‑forget style usage (similar to `requests.request`). It builds a temporary `ClientSession` (owning a fresh `TCPConnector` unless one is supplied), forwards all kwargs to `ClientSession._request`, and returns a context manager that guarantees cleanup of both response and session.  

* **Typical use**  

```python
async with aiohttp.request('GET', 'https://example.com') as resp:
    body = await resp.text()
```

---

## 3. Dependencies & Relationships  

### 3.1 Direct Imports  

| Module | What it provides to this file |
|--------|-------------------------------|
| `asyncio` | Event‑loop primitives, `Future`, `TimeoutError`. |
| `base64`, `hashlib`, `json`, `os`, `sys`, `traceback`, `warnings` | Utility functions (e.g., WS handshake, serialization, deprecation warnings). |
| `contextlib.suppress` | Suppress expected exceptions. |
| `types.TracebackType` | Type annotation for `__exit__` signature. |
| `typing` (various) | Static type hints (`TypedDict`, generics, `Union`, etc.). |
| `attr` | Immutable data class (`ClientTimeout`) and `evolve`. |
| `multidict` (`CIMultiDict`, `MultiDict`, `MultiDictProxy`, `istr`) | Case‑insensitive mutable mapping for HTTP headers. |
| `yarl.URL` | URL parsing & manipulation. |
| `.hdrs` | HTTP header name constants (e.g., `METH_GET`). |
| `.http`, `.http_websocket` (`HttpVersion`, `WS_KEY`, `WebSocketReader/Writer`, `WSHandshakeError`, `ws_ext_gen`, `ws_ext_parse`) | Core HTTP protocol objects, WebSocket handling. |
| `.payload` | Payload classes (e.g., `JsonPayload`). |
| `.client_exceptions` | All client‑side exception classes used throughout the module. |
| `.client_middlewares` (`ClientMiddlewareType`, `build_client_middlewares`) | Middleware composition utilities. |
| `.client_reqrep` (`ClientRequest`, `ClientResponse`, `Fingerprint`, `RequestInfo`, `_merge_ssl_params`) | Request/Response representations and SSL‑param merging. |
| `.client_ws` (`ClientWebSocketResponse`, `ClientWSTimeout`, `DEFAULT_WS_CLIENT_TIMEOUT`) | WebSocket response abstraction. |
| `.connector` (`BaseConnector`, `TCPConnector`, `UnixConnector`, `NamedPipeConnector`, `HTTP_AND_EMPTY_SCHEMA_SET`) | Connection pooling and transport handling. |
| `.cookiejar` (`CookieJar`) | Cookie storage & management. |
| `.helpers` (`_SENTINEL`, `DEBUG`, `EMPTY_BODY_METHODS`, `BasicAuth`, `TimeoutHandle`, `basicauth_from_netrc`, `get_env_proxy_for_url`, `netrc_from_env`, `sentinel`, `strip_auth_from_url`) | Various helper utilities (auth, proxy, timeout handling). |
| `.tracing` (`Trace`, `TraceConfig`) | Request/response tracing hooks. |
| `.typedefs` (`JSONEncoder`, `LooseCookies`, `LooseHeaders`, `Query`, `StrOrURL`) | Type aliases for public API. |

### 3.2 Interaction with Other aiohttp Components  

* **Connectors** – `ClientSession` holds a `BaseConnector` (default `TCPConnector`). The connector is responsible for establishing TCP/SSL connections, re‑using connections, and handling DNS resolution.  
* **Request/Response objects** – The session delegates request construction to `ClientRequest` and wraps the raw response in `ClientResponse`. For WebSockets it uses `ClientWebSocketResponse`.  
* **CookieJar** – Managed via `CookieJar` (or custom `AbstractCookieJar`). Used to add cookies to outgoing requests and update from incoming `Set-Cookie` headers.  
* **Middlewares** – Pluggable functions that wrap the request‑sending coroutine. Built via `build_client_middlewares`.  
* **Tracing** – `Trace` instances are created per request from all `TraceConfig` objects and fire lifecycle events (`send_request_start`, `send_request_end`, etc.).  
* **SSL utilities** – `_merge_ssl_params` consolidates SSL parameters (`verify_ssl`, `ssl_context`, `fingerprint`, `ssl` flag).  
* **WebSocket utilities** – `ws_ext_gen`, `ws_ext_parse`, and the handshake validation logic sit in `http_websocket`.  

### 3.3 Downstream Dependents (logical)  

* **User code** – The public API (`ClientSession`, `request`, convenience methods) is directly used by application developers.  
* **Higher‑level libraries** – Libraries that build on aiohttp (e.g., `aiohttp.web` tests, third‑party API wrappers) invoke these classes/functions.  
* **Testing utilities** – aiohttp’s own test suite creates `ClientSession` instances to drive server fixtures.  

### 3.4 Architectural Placement  

```
+----------------------+      +--------------------+
|   Application Code   | ---> | aiohttp.client.py  |
+----------------------+      +--------------------+
                                   |
                                   v
                +---------------------------+
                |  Connector (TCPConnector) |
                +---------------------------+
                                   |
                                   v
                +---------------------------+
                |  Low‑level Transport (TCP/SSL) |
                +---------------------------+
```

`aiohttp.client` sits at the **edge** of the library, translating high‑level HTTP method calls into concrete network operations handled by the connector and underlying transports. It also mediates auxiliary concerns (cookies, auth, redirects, tracing, middlewares) before delegating to the connector.

---

## 4. Workflow Description  

Below is a **high‑level step‑by‑step** flow for a typical HTTP request (`ClientSession.get` or `session.request`), followed by the WebSocket handshake sequence.

### 4.1 HTTP Request Flow  

1. **User calls** `session.request(method, url, **options)` → returns `_RequestContextManager`.  
2. **`_request` coroutine** starts:  
   * Validates that the session is not closed.  
   * Merges SSL parameters using `_merge_ssl_params`.  
   * Normalises `data` / `json` (creates `JsonPayload` when `json` is supplied).  
   * Prepares the request URL via `_build_url` (relative URLs are joined with `base_url`).  
   * Merges user‑provided and default headers via `_prepare_headers`.  
   * Determines proxy settings (session‑wide defaults, env vars when `trust_env` is true).  
   * Resolves the timeout to a `ClientTimeout` object (`real_timeout`).  
   * Starts a `TimeoutHandle` that will abort the request after `real_timeout.total`.  
   * Instantiates a `Trace` for each configured `TraceConfig`. Emits `send_request_start`.  
3. **Redirect / authentication loop** – While loop repeats on retryable (`IDEMPOTENT_METHODS`) or redirect cases:  
   * Strips credentials from URL, resolves auth (default, netrc, etc.).  
   * Builds the final header set, cookie jar (`_cookie_jar`).  
   * Creates a `ClientRequest` object with all resolved parameters.  
4. **Connector acquisition** – Calls `self._connector.connect(req, ...)` (may reuse an existing connection). Handles `ConnectionTimeoutError`.  
5. **Protocol preparation** – Configures the connection’s `protocol` with read/write timeouts, automatic decompression, read buffer size, etc.  
6. **Request sending** – Calls `req.send(conn)` → streams body (if any).  
7. **Response start** – `resp.start(conn)` reads status line, headers, and sets up response parsing.  
8. **Cookie update** – After headers are read, any `Set-Cookie` values update the session’s `CookieJar`.  
9. **Redirect handling** – If status code is a redirect (301,302,303,307,308) and `allow_redirects=True`: <br>• Emits `send_request_redirect`. <br>• Updates method/body per RFC rules. <br>• Resolves the new URL (including relative handling). <br>• Repeats from step 3 (up to `max_redirects`). |
10. **Finalize** – Once a non‑redirect response is obtained: <br>• Applies `raise_for_status` logic (session‑wide or per‑request). <br>• Registers the timeout handle with the connection (so the timer is cancelled on connection release). <br>• Stores request history in `resp._history`. <br>• Emits `send_request_end`. <br>• Returns the `ClientResponse` object inside the context manager. |
11. **Context manager exit** – `await resp.__aexit__` is called when leaving the `async with` block, which closes the response payload and releases the underlying connection back to the pool.  

### 4.2 WebSocket Connection Flow (`ws_connect`)  

1. **User invokes** `session.ws_connect(url, **ws_opts)` → returns `_WSRequestContextManager`.  
2. **`_ws_connect` coroutine** performs:  
   * Normalises WebSocket‑specific timeout (`ClientWSTimeout`).  
   * Builds default WS upgrade headers (`Upgrade`, `Connection`, `Sec-WebSocket-Version`, `Sec-WebSocket-Key`, optional `Protocol` and `Extensions`).  
   * Resolves SSL like a normal request.  
   * Calls `self.request` with `read_until_eof=False` to obtain a raw HTTP `ClientResponse`. |
3. **Handshake validation** – Confirms status 101 and correct `Upgrade`/`Connection` headers. Verifies the `Sec-WebSocket-Accept` header matches the SHA‑1 of the client key + `WS_KEY`. |
4. **Protocol negotiation** – Parses `Sec-WebSocket-Extensions` if compression is requested. |
5. **Transport setup** – Retrieves the underlying connection, creates a `WebSocketDataQueue` (reader) and a `WebSocketWriter`. Configures read timeout to respect `ws_timeout.ws_receive`. |
6. **Wrap into** `ClientWebSocketResponse` – The response object is returned, exposing `receive`, `send_str`, `close`, etc. |
7. **Context manager exit** – Closing the WS response triggers proper TCP/SSL shutdown and releases the connection.  

---

## 5. Usage Examples  

> The examples below use the public API only; they reflect the real behaviour described in the code.

### 5.1 Basic GET request  

```python
import aiohttp
import asyncio

async def fetch():
    async with aiohttp.ClientSession() as session:
        async with session.get('https://httpbin.org/get',
                              timeout=aiohttp.ClientTimeout(total=30),
                              raise_for_status=True) as resp:
            data = await resp.json()
            print(data)

asyncio.run(fetch())
```

### 5.2 POST with JSON payload and custom headers  

```python
import aiohttp
import asyncio

async def post_json():
    async with aiohttp.ClientSession(
        headers={'User-Agent': 'my-app/1.0'},
        json_serialize=lambda obj: json.dumps(obj, separators=(',', ':')),
    ) as sess:
        payload = {"name": "aiohttp", "type": "example"}
        async with sess.post('https://httpbin.org/post',
                             json=payload,
                             auth=aiohttp.BasicAuth('user', 'pwd')) as r:
            print(await r.text())

asyncio.run(post_json())
```

### 5.3 Using middlewares for logging  

```python
import aiohttp
import asyncio

async def logger_middleware(request, handler):
    print(f'>> {request.method} {request.url}')
    response = await handler(request)
    print(f'<< {response.status}')
    return response

async def main():
    async with aiohttp.ClientSession(
        middlewares=[logger_middleware],
    ) as s:
        async with s.get('https://example.com') as resp:
            await resp.read()

asyncio.run(main())
```

### 5.4 WebSocket client  

```python
import aiohttp
import asyncio

async def ws_demo():
    async with aiohttp.ClientSession() as session:
        async with session.ws_connect('wss://echo.websocket.org') as ws:
            await ws.send_str('hello')
            msg = await ws.receive()
            print('Received:', msg.data)

asyncio.run(ws_demo())
```

### 5.5 One‑shot request (module‑level)  

```python
import aiohttp
import asyncio

async def quick():
    async with aiohttp.request('GET', 'https://httpbin.org/ip') as r:
        print(await r.json())

asyncio.run(quick())
```

---

## 6. Notes for Developers  

| Area | Important Considerations |
|------|--------------------------|
| **Session lifecycle** | Always close a `ClientSession` (`async with` or `await session.close()`). Forgetting to do so raises a `ResourceWarning` and may leak connections. |
| **Thread safety** | The session is **not** thread‑safe. All API calls must happen on the event loop that created the session. |
| **Timeout handling** | `ClientTimeout` values are *cumulative*: the `total` timeout includes connect, DNS, read, and any intermediate processing (redirects, middleware). The internal `TimeoutHandle` forces cancellation of the request coroutine once exceeded. |
| **Redirect loops** | The redirect handling logic respects RFC 9110. `max_redirects` defaults to 10; exceeding it raises `TooManyRedirects`. |
| **Idempotent retry** | Only HTTP methods in `IDEMPOTENT_METHODS` are automatically retried on persistent‑connection failures. Non‑idempotent methods (e.g., `POST`) are never retried automatically. |
| **Proxy & `trust_env`** | When `trust_env=True`, the client inspects `HTTP_PROXY` / `HTTPS_PROXY` environment variables **and** `.netrc` for authentication. Proxy authentication can also be provided explicitly via `proxy_auth`. |
| **Header handling** | `skip_auto_headers` disables automatic header generation (e.g., `User-Agent`, `Accept-Encoding`). The code merges user‑provided headers with defaults and preserves duplicate header names when necessary. |
| **WebSocket compression** | The WS handshake can negotiate per‑message deflate via `compress` argument. If the server replies with an unsupported extension, a `WSServerHandshakeError` is raised. |
| **Middleware order** | Session‑level middlewares are applied first; per‑request `middlewares=` overrides them. The final handler is built by nesting the middlewares around the low‑level `_connect_and_send_request`. |
| **Deprecations** | Several arguments (`read_timeout`, `conn_timeout`, `ssl_shutdown_timeout`, `receive_timeout`) emit `DeprecationWarning`. Use the new `ClientTimeout` or `ClientWSTimeout` objects instead. |
| **Debug tracing** | When `loop.get_debug()` is true, the session records the creation stack trace; this is used to emit more helpful warnings when a session is left unclosed. |
| **Compatibility** | The module contains `TYPE_CHECKING` guards for Python 3.11+ to expose typed overloads using `typing.Unpack`. Runtime code works on any supported Python ≥3.8. |
| **Error mapping** | Low‑level asyncio/OS errors are wrapped into aiohttp‑specific exceptions (`ClientConnectorError`, `ClientOSError`, `ServerDisconnectedError`, etc.) for a consistent public API. |
| **SSL shutdown timeout** | The `ssl_shutdown_timeout` constructor argument is deprecated and will be removed in aiohttp 4.0. |
| **Resource cleanup in `_RequestContextManager`** | `__aexit__` calls `await self._resp.__aexit__`, guaranteeing that the underlying transport is released even if the user never reads the response body. |

---  

**End of Documentation**.