# `aiohttp.helpers` – Utility Functions & Helpers  

## 1. Module Purpose  

| Aspect | Description |
|--------|-------------|
| **Responsibility** | Provides a collection of small, self‑contained utilities used throughout **aiohttp**. These helpers cover HTTP‑specific tasks (e.g., parsing/creating headers, handling authentication, proxy configuration, MIME handling, timeout management, etc.) as well as generic Python helpers (e.g., weak‑ref handling, result/exception setting). |
| **Why it exists** | aiohttp needs a central, well‑tested place for common logic that would otherwise be duplicated in request/response handling, client sessions, servers, and middleware. By keeping this logic in `helpers.py`, the rest of the codebase stays lightweight and focused on higher‑level concerns. |

---

## 2. Key Components  

### 2.1 Constants & Global Flags  

| Name | Meaning |
|------|---------|
| `IS_MACOS`, `IS_WINDOWS` | Platform detection shortcuts. |
| `PY_310`, `PY_311` | Version flags for conditional behaviour. |
| `NO_EXTENSIONS` | Disables optional C extensions when set in the environment. |
| `EMPTY_BODY_STATUS_CODES` | HTTP status codes that must not contain a body (204, 304, 1xx). |
| `EMPTY_BODY_METHODS` | HTTP methods (e.g., `HEAD`) that never have a body. |
| `DEBUG` | Enables debug logging when Python’s dev‑mode or `PYTHONASYNCIODEBUG` is active. |
| `CHAR`, `CTL`, `SEPARATORS`, `TOKEN` | Character sets used when validating token‑style HTTP header values. |
| `ETAG_ANY` | The wildcard etag (`*`). |
| `_EXC_SENTINEL` | Unique sentinel used in `set_exception`. |

---

### 2.2 Classes  

| Class | Overview | Public API |
|-------|----------|------------|
| **`noop`** | Minimal awaitable that does nothing; useful as a placeholder when an awaitable is required. | `__await__` |
| **`BasicAuth`** (namedtuple) | Helper for HTTP Basic authentication. Validates inputs, can **decode** a header, **encode** credentials, or construct from a `yarl.URL`. | `decode`, `from_url`, `encode` |
| **`ProxyInfo`** (`attr.s`) | Simple immutable container that stores a proxy URL and optional `BasicAuth`. | `proxy`, `proxy_auth` |
| **`MimeType`** (`attr.s`) | Represents a parsed MIME type (`type/subtype`, optional `suffix`, and parameters). | `type`, `subtype`, `suffix`, `parameters` |
| **`EnsureOctetStream`** (`EmailMessage`) | Subclass that forces the default content type to `application/octet-stream` and sanitises malformed `Content-Type` header values. | `get_content_type` |
| **`TimeoutHandle`** | Encapsulates a list of timeout callbacks; can start a low‑resolution timer, create a context manager (`timer`) and cancel registered callbacks. | `register`, `start`, `timer`, `close` |
| **`BaseTimerContext`** (abstract) | Context manager contract for low‑resolution timeout scopes. Provides `assert_timeout`. | `__enter__`, `__exit__`, `assert_timeout` |
| **`TimerNoop`** | No‑op implementation of `BaseTimerContext`; does nothing. | `__enter__`, `__exit__`, `assert_timeout` |
| **`TimerContext`** | Real low‑resolution timer that records tasks, cancels them on timeout and surfaces `asyncio.TimeoutError`. | `__enter__`, `__exit__`, `assert_timeout`, `timeout` |
| **`HeadersMixin`** | Mixin that lazily parses `Content-Type`/`charset`/`Content-Length` from a `MultiMapping` headers collection. | `content_type`, `charset`, `content_length` |
| **`ErrorableProtocol`** (typing Protocol) | Describes objects that implement a `set_exception(exc, cause)` method – used by `set_exception`. |
| **`AppKey`** (generic) | Strongly‑typed key for storing arbitrary data on `aiohttp.web.Application`. Implements ordering for deterministic dict‑like merges. | `__repr__`, ordering operators |
| **`ChainMapProxy`** | Read‑only mapping that searches a sequence of underlying mappings, disallowing inheritance. Mimics `collections.ChainMap` but immutable. | `__getitem__`, `get`, `__len__`, `__iter__`, `__contains__` |
| **`ETag`** (`attr.s`) | Simple immutable representation of an HTTP entity tag (value + weak flag). | `value`, `is_weak` |

---

### 2.3 Functions  

| Function | Purpose | Signature & Types | Return |
|----------|---------|-------------------|--------|
| **`strip_auth_from_url(url)`** | Remove user/password from a `yarl.URL` and return the cleaned URL plus a `BasicAuth` object (or `None`). | `(url: URL) -> Tuple[URL, Optional[BasicAuth]]` | `(url_without_auth, BasicAuth|None)` |
| **`netrc_from_env()`** | Load a `.netrc` file from `$NETRC` or the default location (`~/.netrc` / `~/_netrc`). Returns a `netrc.netrc` object or `None`. | `() -> Optional[netrc.netrc]` | `netrc` object or `None` |
| **`basicauth_from_netrc(netrc_obj, host)`** | Pull `BasicAuth` credentials for a hostname from a parsed netrc object. Raises `LookupError` when missing. | `(netrc_obj: Optional[netrc.netrc], host: str) -> BasicAuth` | `BasicAuth` |
| **`proxies_from_env()`** | Build a dictionary of proxy configurations (`http`, `https`, `ws`, `wss`) from environment variables, handling authentication via URL or netrc. | `() -> Dict[str, ProxyInfo]` | Mapping of scheme → `ProxyInfo` |
| **`get_env_proxy_for_url(url)`** | Return the appropriate proxy (URL + optional auth) for a given target URL, respecting `NO_PROXY`/proxy‑bypass. | `(url: URL) -> Tuple[URL, Optional[BasicAuth]]` | `(proxy_url, auth|None)` |
| **`parse_mimetype(mimetype)`** | Parse a MIME type string into its components (type, subtype, suffix, params). Cached LRU. | `(mimetype: str) -> MimeType` | `MimeType` |
| **`parse_content_type(raw)`** | Parse a raw `Content-Type` header into a canonical type string and an immutable dict of parameters; defaults to `application/octet-stream`. | `(raw: str) -> Tuple[str, MappingProxyType[str, str]]` | `(content_type, params)` |
| **`guess_filename(obj, default=None)`** | Attempt to extract a filename from an object that has a `name` attribute. | `(obj: Any, default: Optional[str]=None) -> Optional[str]` | Filename or `default` |
| **`quoted_string(content)`** | Encode a 7‑bit string as an RFC‑5322 quoted‑string, escaping necessary characters. | `(content: str) -> str` | Quoted string |
| **`content_disposition_header(disptype, quote_fields=True, _charset='utf-8', **params)`** | Build a MIME `Content‑Disposition` header string, optionally quoting values per RFC‑7578. | `(disptype: str, quote_fields: bool=True, _charset: str='utf-8', **params: str) -> str` | Header value |
| **`is_ip_address(host)`** | Heuristic test whether a host string looks like an IPv4 or IPv6 address. | `(host: Optional[str]) -> bool` | `True/False` |
| **`rfc822_formatted_time()`** | Return the current UTC time formatted per RFC‑822/1123 (cached per second). | `() -> str` | Formatted date string |
| **`weakref_handle(ob, name, timeout, loop, timeout_ceil_threshold=5)`** | Schedule a weak‑ref based callback on the loop after a timeout; useful for cleaning up objects without keeping a strong reference. | `(ob: object, name: str, timeout: float, loop: AbstractEventLoop, timeout_ceil_threshold: float=5) -> Optional[TimerHandle]` | `TimerHandle` |
| **`call_later(cb, timeout, loop, timeout_ceil_threshold=5)`** | Schedule a plain callable after a timeout (similar to `loop.call_later`). | `(cb: Callable[[], Any], timeout: float, loop: AbstractEventLoop, timeout_ceil_threshold: float=5) -> Optional[TimerHandle]` | `TimerHandle` |
| **`calculate_timeout_when(loop_time, timeout, timeout_ceiling_threshold)`** | Compute the absolute loop time when a timeout should fire; optionally rounds up to the next integer for large values. | `(loop_time: float, timeout: float, timeout_ceiling_threshold: float) -> float` | Absolute time |
| **`ceil_timeout(delay, ceil_threshold=5)`** | Return an `async_timeout.Timeout` object that expires after `delay` seconds, rounding up for large values. | `(delay: Optional[float], ceil_threshold: float=5) -> async_timeout.Timeout` | Timeout context manager |
| **`set_result(fut, result)`** | Safely set a result on a future if it isn’t already done. | `(fut: Future[_T], result: _T) -> None` | None |
| **`set_exception(fut, exc, exc_cause=_EXC_SENTINEL)`** | Set an exception on a future (or any object supporting `set_exception`). Optionally chain a cause. | `(fut: Future[_T] | ErrorableProtocol, exc: BaseException, exc_cause: BaseException=_EXC_SENTINEL) -> None` | None |
| **`validate_etag_value(value)`** | Validate that a string is a legal ETag token (or `*`). Raises `ValueError` if invalid. | `(value: str) -> None` | None |
| **`parse_http_date(date_str)`** | Convert an HTTP date string to a UTC `datetime` object; returns `None` on failure. | `(date_str: Optional[str]) -> Optional[datetime.datetime]` | `datetime` or `None` |
| **`must_be_empty_body(method, code)`** | Determine whether a response must have an empty body based on method and status code. Cached. | `(method: str, code: int) -> bool` | `True/False` |
| **`should_remove_content_length(method, code)`** | Determine whether a `Content‑Length` header should be omitted, based on RFC rules. | `(method: str, code: int) -> bool` | `True/False` |

---

## 3. Dependencies & Relationships  

### 3.1 Imports  

| Module | Reason |
|--------|--------|
| `asyncio`, `async_timeout` | Timer/loop handling, timeout context. |
| `base64`, `binascii` | Encoding/decoding Basic auth. |
| `contextlib`, `weakref`, `suppress` | Resource cleanup, weak‑ref callbacks. |
| `datetime`, `time` | RFC‑822 date formatting & parsing. |
| `enum` | Sentinel enum for internal use. |
| `functools` (`lru_cache`, `total_ordering`) | Caching and ordering helpers. |
| `inspect` | Determining module name for `AppKey`. |
| `netrc` | Reading `~/.netrc` files. |
| `os`, `platform`, `sys` | Environment, platform detection, debug flags. |
| `re` | Regex for token/ETag validation. |
| `email.*` (`EmailMessage`, `HeaderParser`, `HTTP`) | Parsing and normalising `Content-Type` header. |
| `math.ceil` | Rounding up large timeout values. |
| `pathlib.Path` | File‑system paths (netrc location). |
| `types` (`MappingProxyType`, `TracebackType`) | Immutable mapping and exception handling. |
| `typing` (extensive) | Type hints. |
| `urllib.parse.quote`, `urllib.request.getproxies`, `proxy_bypass` | URL quoting and proxy discovery. |
| `attr` | Dataclass‑like containers (`ProxyInfo`, `MimeType`, `ETag`). |
| `multidict` (`MultiDict`, `MultiDictProxy`, `MultiMapping`) | Header collections and MIME parameters. |
| `propcache.api.reify` | Cached property decorator (exposed as `reify`). |
| `yarl.URL` | URL parsing and manipulation. |
| Local imports: `hdrs`, `log.client_logger` | HTTP constant definitions and internal logging. |

### 3.2 Interaction with the Rest of aiohttp  

| Component in aiohttp | How it uses `helpers` |
|----------------------|-----------------------|
| **ClientSession / Request** | Uses `BasicAuth`, `parse_mimetype`, `parse_content_type`, `guess_filename`, timeout helpers (`call_later`, `TimeoutHandle`), proxy utilities (`proxies_from_env`, `get_env_proxy_for_url`). |
| **Server / WebResponse** | Uses `HeadersMixin` to expose `content_type`, `charset`, `content_length`. |
| **Web Application** | Stores and retrieves `AppKey` values; `ChainMapProxy` provides read‑only view of merged app dictionaries. |
| **HTTP Parsers** | `parse_http_date`, `parse_content_type`, `ETag`, `validate_etag_value` used by conditionals & caching logic. |
| **Logging & Debug** | `client_logger` used for warnings in netrc/proxy handling. |
| **Test Suites** | Many helpers are imported directly for unit testing (e.g., `rfc822_formatted_time`, `must_be_empty_body`). |

### 3.3 Potential Consumers (Logical)  

* Client‑side request building modules.
* Server‑side response generation.
* Middleware that deals with authentication, caching, or proxy handling.
* Internal utilities that need deterministic header parsing or MIME type handling.

---

## 4. Workflow Description  

Below is a high‑level flow of typical operations involving this module:

1. **URL / Proxy Preparation**  
   * `proxies_from_env()` reads environment variables via `urllib.request.getproxies()`.  
   * For each proxy URL it calls `strip_auth_from_url()` → removes credentials & builds `BasicAuth`.  
   * If credentials are missing and a netrc file exists (`netrc_from_env()`), `basicauth_from_netrc()` is consulted.  
   * Resulting `ProxyInfo` objects are stored in a dict keyed by scheme.

2. **Authentication Handling**  
   * `BasicAuth.from_url()` extracts user/password from a `yarl.URL`.  
   * `BasicAuth.encode()` creates the `Authorization: Basic …` header.  
   * `BasicAuth.decode()` parses a received header back into a `BasicAuth` object.

3. **Header Parsing**  
   * `HeadersMixin._parse_content_type()` lazily parses `Content‑Type` using `parse_content_type()`.  
   * The mixin exposes convenient properties (`content_type`, `charset`, `content_length`).  

4. **MIME & Content‑Disposition**  
   * `parse_mimetype()` splits `"type/subtype+suffix; param=value"` into a `MimeType`.  
   * `content_disposition_header()` constructs a valid `Content‑Disposition` header, handling quoting and RFC‑5987 encoding.

5. **Date & Time Utilities**  
   * `rfc822_formatted_time()` returns a cached HTTP‑date string (updated once per second).  
   * `parse_http_date()` converts an HTTP date string back to a UTC `datetime`.

6. **Timeout Management**  
   * `call_later()` and `weakref_handle()` schedule callbacks on the event loop, optionally rounding large timeouts (via `calculate_timeout_when`).  
   * `TimeoutHandle` groups multiple callbacks; its `timer()` method yields a `TimerContext` that can cancel tasks on timeout.  
   * `ceil_timeout()` provides an `async_timeout` context manager compatible with `async with`.

7. **Future Helpers**  
   * `set_result()` safely resolves a future if not already done.  
   * `set_exception()` attaches an exception (with optional cause) to a future or any object following `ErrorableProtocol`.

8. **ETag & Conditional Request Support**  
   * `ETag` class stores an entity tag; `validate_etag_value()` ensures format compliance.  
   * `must_be_empty_body()` and `should_remove_content_length()` encapsulate RFC rules for when a response body or `Content‑Length` header is prohibited.

9. **Application Data Keys**  
   * `AppKey` instances are created with a module‑qualified name to guarantee uniqueness.  
   * `ChainMapProxy` merges multiple mappings (e.g., app config, sub‑app config) into a read‑only view for lookup.

---

## 5. Usage Examples  

> **Note:** The examples below illustrate typical patterns; they are directly inferable from the public API.

### 5.1 Basic Auth from a URL  

```python
from yarl import URL
from aiohttp.helpers import BasicAuth

url = URL("https://user:secret@example.com/")
auth = BasicAuth.from_url(url)          # -> BasicAuth('user', 'secret')
header = {"Authorization": auth.encode()}
```

### 5.2 Getting a Proxy from the Environment  

```python
from aiohttp.helpers import get_env_proxy_for_url, URL

target = URL("http://example.com")
proxy_url, proxy_auth = get_env_proxy_for_url(target)

if proxy_auth:
    print(f"Proxy {proxy_url} requires auth {proxy_auth.login}")
else:
    print(f"Using proxy {proxy_url} without authentication")
```

### 5.3 Parsing a Content‑Type Header  

```python
from aiohttp.helpers import parse_content_type

ctype, params = parse_content_type('text/html; charset="utf-8"')
# ctype  -> 'text/html'
# params -> {'charset': 'utf-8'}
```

### 5.4 Building a Content‑Disposition Header  

```python
from aiohttp.helpers import content_disposition_header

header = content_disposition_header(
    "attachment",
    filename="résumé.pdf",
    size="12345",
)
# header -> 'attachment; filename="resume.pdf"; size="12345"'
```

### 5.5 Using a Low‑Resolution Timeout  

```python
import asyncio
from aiohttp.helpers import TimeoutHandle

async def long_running():
    await asyncio.sleep(10)

loop = asyncio.get_running_loop()
t_handle = TimeoutHandle(loop, timeout=2.0)   # 2‑second timeout
t_handle.register(lambda: print("Operation timed out"))
timer = t_handle.timer()

async with timer:
    await long_running()   # Will be cancelled after ~2 s, raising asyncio.TimeoutError
```

### 5.6 Storing Typed Data in an Application  

```python
from aiohttp.helpers import AppKey

USER_DB = AppKey("user_db", dict)

app[USER_DB] = {"alice": 1, "bob": 2}
# Later:
db = app[USER_DB]   # type‑checked as dict
```

---

## 6. Notes for Developers  

| Area | Gotchas / Recommendations |
|------|----------------------------|
| **BasicAuth validation** | The class forbids a colon in the username as per RFC 1945. Ensure callers respect this (e.g., when extracting credentials from URLs that may contain `:`). |
| **Proxy handling** | `proxies_from_env` silently ignores HTTPS/WSS proxies because aiohttp does not support them (warning is logged). |
| **Token validation** | `TOKEN` is derived from RFC‑2616; any future change to the spec may require updating the set definition. |
| **Weak‑ref callbacks** | The `weakref_handle` utility creates a timer that calls a method on the object if it still exists. Be careful with circular references – the weak‑ref keeps the object alive only while other references exist. |
| **Timeout rounding** | When `timeout >= 5` seconds the computed trigger point is rounded up (`ceil`). This reduces the number of timer events on busy loops, but can introduce a small drift. |
| **Header parsing caching** | `parse_content_type` and `parse_mimetype` are `lru_cache`‑ed with a modest size (56). In high‑throughput servers, repeated unique values will bust the cache; consider pre‑parsing common types if performance becomes an issue. |
| **ETag validation** | `validate_etag_value` only checks token characters; it does **not** enforce surrounding quotes. It is used internally when constructing `ETag` objects. |
| **`HeadersMixin` lazy parsing** | The mixin caches the raw string it last saw (`_stored_content_type`). If the underlying header mapping mutates without updating the mixin, the cached values may become stale. Use the mixin only with immutable header collections (as aiohttp does). |
| **`AppKey` ordering** | The `__lt__` implementation places `AppKey` instances before non‑`AppKey` objects; this is intentional for deterministic merging of `ChainMapProxy`. |
| **`ChainMapProxy` immutability** | The class deliberately blocks subclassing (`__init_subclass__` raises). Treat it as a read‑only view; do not attempt to modify underlying maps via the proxy. |
| **Python version differences** | Some branches handle netrc parsing differences between Python 3.10 and 3.11 (e.g., handling of empty login/account). Keep an eye on future releases that may change these semantics. |
| **Debug flag** | `DEBUG` mirrors Python’s dev mode or `PYTHONASYNCIODEBUG`. Several helpers emit additional logs when this flag is true. |

--- 

**End of `aiohttp.helpers` documentation**.  