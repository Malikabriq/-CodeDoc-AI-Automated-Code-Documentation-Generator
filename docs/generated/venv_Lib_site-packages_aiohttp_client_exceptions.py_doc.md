# aiohttp.client_exceptions  
*Module level documentation*

---

## 1. Module Purpose  

| **What** | **Why** |
|----------|----------|
|Defines a comprehensive hierarchy of exception classes used by **aiohttp** client‑side code.|All network‑related failures, HTTP protocol violations, URL validation problems, and SSL issues must be reported in a structured, consistent way so that library users can catch and handle them precisely.|
|Provides deprecation helpers for the old `code` attribute (replaced by `status`).|Keeps backward compatibility with older aiohttp releases while encouraging migration to the newer API.|
|Contains small utility logic for rich string/representation formatting of errors.|Improves debuggability by exposing request/response details, host/port information, and underlying OS/SSL errors. |

The module lives under `aiohttp/` because every high‑level client component (e.g., `ClientSession`, `TCPConnector`, HTTP request/response handling, WebSocket client, proxy handling) raises one of these exceptions.

---

## 2. Key Components  

Below each public class is described with its purpose, constructor signature, important attributes, and the part of the public API it contributes.

### Base Classes  

| Class | Purpose | Constructor / Important Attributes | Public API |
|-------|---------|------------------------------------|-----------|
| **`ClientError`** | Root of all client‑side errors. | No arguments – inherits directly from `Exception`. | Used as a catch‑all for any aiohttp client exception (`except aiohttp.ClientError`). |
| **`ClientConnectionError`** | Base for errors that happen at the socket/transport level before a response is received. | No arguments – inherits from `ClientError`. | Subclassed by concrete connection‑related errors. |
| **`ClientResponseError`** | Base for errors **after** a response line has been received (e.g., non‑2xx status, invalid content type). | `__init__(request_info, history, *, code=None, status=None, message="", headers=None)`<br>• `request_info: RequestInfo` – object describing the original request (URL, method, etc.).<br>• `history: Tuple[ClientResponse, …]` – prior responses if redirects occurred.<br>• `status` (preferred) or legacy `code` – HTTP status int.<br>• `message: str` – optional server‑provided message.<br>• `headers: MultiMapping[str]` – response headers. | Attributes: `request_info`, `history`, `status`, `message`, `headers`. <br>Properties: deprecated `code` (maps to `status`). <br>String/repr provide detailed context. |

### Response‑related Errors  

| Class | What it Represents | Inheritance | Key Details |
|-------|-------------------|-------------|-------------|
| **`ContentTypeError`** | Server returned a MIME type that the client cannot handle (e.g., expecting JSON but got XML). | `ClientResponseError` | No extra data; simply signals the condition. |
| **`WSServerHandshakeError`** | WebSocket handshake failed (invalid status, missing headers, etc.). | `ClientResponseError` | Same payload as its base – `request_info`, `status`, … |
| **`ClientHttpProxyError`** | Proxy responded with a non‑`200 OK` to a `CONNECT` request. | `ClientResponseError` | Used by `aiohttp.connector.TCPConnector`. |
| **`TooManyRedirects`** | The client followed more redirects than allowed (`max_redirects`). | `ClientResponseError` | Signals a redirect loop or mis‑configured endpoint. |
| **`ClientPayloadError`** | Problems while reading or decoding the response body (e.g., truncated payload). | `ClientError` | No special fields. |
| **`ServerConnectionError`** | Errors that occur **after** a TCP connection has been established (server‑side failures). | `ClientConnectionError` | Base for server‑side subclasses. |
| **`ServerDisconnectedError`** | Server closed the connection unexpectedly. | `ServerConnectionError` | `message` attribute defaults to `"Server disconnected"` if not supplied. |
| **`ServerTimeoutError`** | A timeout while waiting for a response from the server. | `ServerConnectionError`, `asyncio.TimeoutError` | Used by the timeout handling logic of `ClientSession`. |
| **`ConnectionTimeoutError`** | Specific timeout for establishing the TCP connection. | `ServerTimeoutError` | Distinguishes from read/write timeouts. |
| **`SocketTimeoutError`** | Timeout on a read/write operation on the socket after the connection is established. | `ServerTimeoutError` | Same hierarchy as above. |
| **`ServerFingerprintMismatch`** | SSL/TLS certificate fingerprint presented by the server does not match the expected fingerprint (manual pinning). | `ServerConnectionError` | Stores `expected`, `got`, `host`, `port`. Provides custom `__repr__`. |
| **`WSMessageTypeError`** | Invalid type passed to `aiohttp.WebSocketResponse` methods (e.g., sending a non‑bytes/text value). | `TypeError` | Simple marker; no extra data. |

### Connection‑related Errors  

| Class | What it Represents | Inheritance | Important Attributes & Logic |
|-------|-------------------|-------------|-----------------------------|
| **`ClientConnectorError`** | Generic failure to **establish** a connection (DNS resolved, but `socket.connect` fails). | `ClientOSError` | Constructor receives `connection_key: ConnectionKey` and the original `os_error: OSError`. Stores them in private attrs `_conn_key`, `_os_error`. Exposes properties `host`, `port`, `ssl`. Custom `__str__` formats “Cannot connect to host …”. |
| **`ClientConnectorDNSError`** | DNS resolution failed while building the `ConnectionKey`. | `ClientConnectorError` | No extra fields – inherits all from its parent. |
| **`ClientProxyConnectionError`** | Cannot connect to the configured HTTP/HTTPS proxy. | `ClientConnectorError` | Same payload as parent. |
| **`UnixClientConnectorError`** | Failure to connect to a Unix domain socket (used by `UnixConnector`). | `ClientConnectorError` | Adds `path: str` attribute; custom `__str__` mentions the socket path. |
| **`ClientOSError`** | Wrapper for generic `OSError` failures at the socket level. | `ClientConnectionError`, `OSError` | No additional logic – exists for the inheritance hierarchy. |
| **`ClientConnectionResetError`** | Underlying `ConnectionResetError` bubbled up while talking to the server. | `ClientConnectionError`, `ConnectionResetError` | No extra fields. |

### SSL / Certificate Errors  

| Class | Description | Inheritance (dynamic) | Key Points |
|-------|-------------|-----------------------|------------|
| **`ClientSSLError`** | Base for all errors that stem from the `ssl` module. | `ClientConnectorError` | Acts as a marker; concrete subclasses are created later based on availability of the `ssl` module. |
| **`ClientConnectorSSLError`** | SSL handshake failure (e.g., protocol mismatch, certificate validation error). | Dynamically inherits from `ClientSSLError` + `ssl.SSLError` (if `ssl` is present) | No custom attributes; the original `ssl.SSLError` is retained as part of the MRO, so its properties (e.g., `reason`) are available. |
| **`ClientConnectorCertificateError`** | Certificate validation error (e.g., hostname mismatch, expired cert). | Dynamically inherits from `ClientSSLError` + `ssl.CertificateError` (if `ssl` is present) | Stores the original exception as `certificate_error`. Provides `host`, `port`, `ssl` (bool) properties derived from the `ConnectionKey`. Custom `__str__` formats a concise description. |

### URL Validation Errors  

| Class | What it Captures | Inheritance | Important Attributes |
|-------|------------------|-------------|----------------------|
| **`InvalidURL`** | The supplied URL string cannot be parsed into a valid HTTP URL (missing host, illegal characters, etc.). | `ClientError`, `ValueError` (for backward compatibility) | `_url: StrOrURL`, `_description: Optional[str]`. Implements `url` and `description` read‑only properties. Custom `__repr__` and `__str__` reflect the optional description. |
| **`InvalidUrlClientError`** | Alias that signals an *invalid URL* in client code (kept for naming consistency). | `InvalidURL` | No extra data. |
| **`RedirectClientError`** | Base class for redirect‑related client errors (used when a redirect target is malformed). | `ClientError` | No attributes. |
| **`NonHttpUrlClientError`** | URL uses a scheme other than `http` or `https`. | `ClientError` | No attributes. |
| **`InvalidUrlRedirectClientError`** | Combination: a redirect target is an invalid URL. | `InvalidUrlClientError`, `RedirectClientError` | Inherits all from parents. |
| **`NonHttpUrlRedirectClientError`** | Redirect target uses a non‑HTTP scheme. | `NonHttpUrlClientError`, `RedirectClientError` | Same as above. |

---

## 3. Dependencies & Relationships  

### Imports  

| Module | Reason for Import |
|--------|-------------------|
| `asyncio` | Base class for `ServerTimeoutError` (inherits `asyncio.TimeoutError`). |
| `warnings` | Used to emit deprecation warnings for the `code` argument/property. |
| `typing` (`TYPE_CHECKING`, `Optional`, `Tuple`, `Union`) | Type hints and conditional imports for static analysis. |
| `multidict.MultiMapping` | Type of the `headers` argument in `ClientResponseError`. |
| `.typedefs.StrOrURL` | Alias for a URL type that can be a string or a `yarl.URL`. |
| `ssl` (optional) | Provides concrete SSL exception classes when the interpreter supplies the module. |
| `.client_reqrep` (conditional) – `ClientResponse`, `ConnectionKey`, `Fingerprint`, `RequestInfo` | Types used in constructor signatures and property returns. |
| `.http_parser` (conditional) – `RawResponseMessage` | Used only for the optional `message` argument of `ServerDisconnectedError`. |

### Interaction with the Rest of aiohttp  

| Direction | Component | How it uses this module |
|-----------|-----------|------------------------|
| **Depends on** | `aiohttp.client_reqrep` (request/response objects) | Exceptions carry `RequestInfo` and response history. |
| | `aiohttp.connector` (`TCPConnector`, `UnixConnector`) | Raises `ClientConnector*` errors when establishing connections. |
| | `aiohttp.client` (`ClientSession`, `ClientResponse`) | Catches and re‑raises these exceptions to user code. |
| | `aiohttp.web_ws` (WebSocket client) | Raises `WSServerHandshakeError` and `WSMessageTypeError`. |
| **Potential callers** | User code (`async with aiohttp.ClientSession() as sess: …`) | Users typically catch `aiohttp.ClientError` or more specific subclasses. |
| | Internal retry / timeout logic | Checks for subclasses like `ServerTimeoutError` or `ConnectionTimeoutError` to decide on retries. |
| | Test suites & utilities | Import these classes directly to assert expected failures. |

These exceptions form the *contract* between low‑level transport layers and the high‑level user API.

---

## 4. Workflow Description  

1. **Request creation** – `ClientSession.request()` builds a `RequestInfo` object that describes the upcoming HTTP transaction.

2. **Connection phase** – `TCPConnector.connect()` attempts to open a socket:
   * If DNS fails → `ClientConnectorDNSError`.
   * If the socket cannot be opened → `ClientConnectorError` (wrapping the original `OSError`).
   * If a proxy is used and the connection fails → `ClientProxyConnectionError`.
   * If a Unix socket path is supplied and fails → `UnixClientConnectorError`.

3. **TLS handshake** (optional) – During SSL negotiation:
   * Generic SSL errors → `ClientConnectorSSLError`.
   * Certificate validation failures → `ClientConnectorCertificateError`.

4. **Sending request & receiving response** – After the connection is established the HTTP request is sent.
   * If the server replies with a non‑OK status that the client deems an error (e.g., 4xx/5xx when `raise_for_status` is used) → `ClientResponseError` (or a subclass such as `ContentTypeError`, `TooManyRedirects`, `ClientHttpProxyError`).
   * The response object (or its `history` of redirects) is attached to the exception for introspection.

5. **Reading payload** – While reading the body:
   * Truncated or malformed payload → `ClientPayloadError`.

6. **Timeout handling** – The client schedules `asyncio` timers:
   * Overall operation timeout → `ServerTimeoutError`.
   * Connection establishment timeout → `ConnectionTimeoutError`.
   * Read/write timeout on the socket → `SocketTimeoutError`.

7. **WebSocket workflow** – When establishing a WebSocket:
   * Handshake problem (e.g., unexpected status code) → `WSServerHandshakeError`.
   * Trying to send a message of an unsupported type → `WSMessageTypeError`.

8. **Error propagation** – Each exception class builds a helpful `__str__`/`__repr__` that includes:
   * Host/port, SSL context, original OS/SSL error description.
   * Request URL, status code, and server‑provided message when applicable.

9. **User handling** – The caller can either:
   * Catch the generic `ClientError` to handle any client‑side failure.
   * Catch a concrete subclass for fine‑grained recovery (e.g., retry on `ConnectionTimeoutError`, abort on `InvalidURL`).

---

## 5. Usage Examples  

> **Note:** The examples use only the public API that can be inferred from the source code.

```python
import aiohttp
from aiohttp import ClientError, ClientResponseError, InvalidURL

async def fetch(url):
    try:
        async with aiohttp.ClientSession() as session:
            async with session.get(url) as resp:
                # raise_for_status will turn non‑2xx into ClientResponseError
                resp.raise_for_status()
                return await resp.text()
    except InvalidURL as exc:
        # URL parsing problems – see exc.url and exc.description
        print(f"Bad URL: {exc}")
    except ClientResponseError as exc:
        # Server returned an error status
        print(f"HTTP {exc.status} – {exc.message}")
        print(f"Request URL was: {exc.request_info.real_url}")
    except ClientError as exc:
        # Any other aiohttp‑related problem (connection, timeout, SSL, etc.)
        print(f"Aiohttp client error: {exc}")

# Example call
# await fetch("http://example.invalid")
```

```python
# Demonstrating a connection timeout handling
import asyncio
import aiohttp

async def main():
    timeout = aiohttp.ClientTimeout(connect=0.1)   # very short connect timeout
    try:
        async with aiohttp.ClientSession(timeout=timeout) as sess:
            await sess.get("https://httpbin.org/delay/5")
    except aiohttp.ConnectionTimeoutError as exc:
        print("Could not connect quickly enough:", exc)

# asyncio.run(main())
```

```python
# Catching SSL certificate fingerprint mismatch
try:
    async with aiohttp.ClientSession() as sess:
        await sess.get("https://example.com",
                       ssl=aiohttp.Fingerprint(b"deadbeef"*8))
except aiohttp.ServerFingerprintMismatch as exc:
    print(f"Expected {exc.expected!r} but got {exc.got!r}")
```

---

## 6. Notes for Developers  

| Area | Guidance / Pitfalls |
|------|---------------------|
| **Deprecation of `code`** | The `ClientResponseError` constructor still accepts a `code` argument for backward compatibility, but it raises a `DeprecationWarning` and maps to `status`. New code should always use the `status` keyword. |
| **MRO for SSL errors** | When the `ssl` module is present, `ClientConnectorSSLError` and `ClientConnectorCertificateError` inherit **both** the aiohttp base and the native `ssl` exception classes. This means `isinstance(err, ssl.SSLError)` is `True`. If the `ssl` module is missing (e.g., some embedded Python builds) the hierarchy falls back to `ClientSSLError` + `ValueError`. Ensure any `except ssl.SSLError` blocks work on all platforms. |
| **Pickling / Serialization** | The module overrides `__reduce__` for `ClientConnectorError` to avoid the default `OSError` reduction that embeds internal state not needed for reconstruction. Do not rely on pickling these exceptions in user code. |
| **Thread‑safety** | All exception objects are immutable after construction (only read‑only properties). They can be safely re‑raised from different coroutines or threads. |
| **Error message consistency** | Many `__str__` implementations embed `self.strerror` (from the underlying `OSError`). This attribute is populated by the `OSError` base class during `super().__init__(errno, strerror)`. Ensure that any subclass that overrides `__init__` calls `super().__init__` appropriately, otherwise `strerror` may be missing. |
| **Testing** | When writing unit tests that simulate network failures, instantiate the concrete exception classes directly (e.g., `ClientConnectorError(ConnectionKey(...), OSError(...))`) to avoid real network traffic. |
| **Compatibility with older aiohttp versions** | The public API deliberately keeps the old names (`InvalidUrlClientError`, `RedirectClientError`, etc.) as thin subclasses. Removing them would be a breaking change. |
| **Future extensions** | If new transport mechanisms (e.g., QUIC) are added, follow the existing pattern: create a specific subclass of `ClientConnectorError` (or `ClientConnectionError`) and expose relevant properties (`host`, `port`, `ssl`). |
| **Documentation generation** | The `__all__` tuple controls what gets exported when users perform `from aiohttp.client_exceptions import *`. Keep it in sync with any newly introduced exception classes. |

--- 

*End of `aiohttp.client_exceptions` documentation.*